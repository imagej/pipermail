<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;base&nbsp;href=&quot;http://fiji.sc/bugzilla/&quot;&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;b&gt;&lt;a&nbsp;class=&quot;bz_bug_link&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bz_status_NEW&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;title=&quot;NEW&nbsp;-&nbsp;Mac&nbsp;OS&nbsp;out&nbsp;of&nbsp;memory&quot;<br>
&nbsp;&nbsp;&nbsp;href=&quot;http://fiji.sc/bugzilla/show_bug.cgi?id=990#c2&quot;&gt;Comment&nbsp;#&nbsp;2&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;&lt;a&nbsp;class=&quot;bz_bug_link&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bz_status_NEW&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;title=&quot;NEW&nbsp;-&nbsp;Mac&nbsp;OS&nbsp;out&nbsp;of&nbsp;memory&quot;<br>
&nbsp;&nbsp;&nbsp;href=&quot;http://fiji.sc/bugzilla/show_bug.cgi?id=990&quot;&gt;bug&nbsp;990&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;&lt;span&nbsp;class=&quot;vcard&quot;&gt;&lt;a&nbsp;class=&quot;email&quot;&nbsp;href=&quot;mailto:glenmac&#64;uw.edu&quot;&nbsp;title=&quot;Glen&nbsp;MacDonald&nbsp;&lt;glenmac&#64;uw.edu&gt;&quot;&gt;&nbsp;&lt;span&nbsp;class=&quot;fn&quot;&gt;Glen&nbsp;MacDonald&lt;/span&gt;&lt;/a&gt;<br>
&lt;/span&gt;&lt;/b&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;Hi&nbsp;Wayne,<br>
First&nbsp;time&nbsp;replying&nbsp;on&nbsp;BugZilla,&nbsp;so&nbsp;hoping&nbsp;this&nbsp;is&nbsp;correct.<br>
Here&nbsp;are&nbsp;macros&nbsp;that&nbsp;[1]&nbsp;generates&nbsp;4&nbsp;stacks&nbsp;then&nbsp;[2]&nbsp;opens&nbsp;files,&nbsp;creates&nbsp;a<br>
montage&nbsp;and&nbsp;also&nbsp;prints&nbsp;out&nbsp;memory&nbsp;usage&nbsp;at&nbsp;each&nbsp;step.&nbsp;&nbsp;I’ve&nbsp;tried&nbsp;with&nbsp;various<br>
stack&nbsp;sizes.&nbsp;Behavior&nbsp;is&nbsp;not&nbsp;entirely&nbsp;consistent&nbsp;on&nbsp;any&nbsp;computer,&nbsp;sometimes&nbsp;all<br>
memory&nbsp;is&nbsp;released&nbsp;when&nbsp;the&nbsp;macro&nbsp;finishes&nbsp;with&nbsp;small&nbsp;stacks.&nbsp;But&nbsp;never&nbsp;with<br>
large&nbsp;stacks.&nbsp;&nbsp;<br>
When&nbsp;the&nbsp;finished&nbsp;montage&nbsp;does&nbsp;release&nbsp;memory,I&nbsp;was&nbsp;surprised&nbsp;that&nbsp;the&nbsp;memory<br>
for&nbsp;each&nbsp;component&nbsp;stack&nbsp;is&nbsp;not&nbsp;released&nbsp;when&nbsp;that&nbsp;stack&nbsp;is&nbsp;closed,&nbsp;only&nbsp;when<br>
the&nbsp;macro&nbsp;exits.&nbsp;&nbsp;This&nbsp;means&nbsp;the&nbsp;maximum&nbsp;size&nbsp;of&nbsp;a&nbsp;montage&nbsp;is&nbsp;1/2&nbsp;the&nbsp;available<br>
memory.&nbsp;&nbsp;&nbsp;I&nbsp;ran&nbsp;the&nbsp;debugger&nbsp;bug&nbsp;but&nbsp;saw&nbsp;nothing&nbsp;intelligible&nbsp;to&nbsp;me.&nbsp;&nbsp;<br>
<br>
<br>
macro&nbsp;&quot;make&nbsp;stacks&nbsp;[1]&quot;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;target=getDirectory(&quot;Source&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(s=0;s&lt;4;s++){<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newImage(&quot;HyperStack&quot;,&nbsp;&quot;16-bit&nbsp;ramp&quot;,&nbsp;1024,&nbsp;1024,&nbsp;3,100,1);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;saveAs(&quot;Tiff&quot;,target+&quot;Stack000&quot;+s);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
&nbsp;macro&nbsp;&quot;make&nbsp;montages&nbsp;[2]&quot;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dir=getDirectory(&quot;Source&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dirList=getFileList(dir);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fList=newArray(0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;Start&nbsp;Macro-&nbsp;Free&nbsp;memory:&quot;,IJ.freeMemory(),&nbsp;&quot;Currently&nbsp;in<br>
use:&quot;,IJ.currentMemory());<br>
&nbsp;&nbsp;&nbsp;&nbsp;newImage(&quot;Hyperstack&quot;,&nbsp;&quot;16-bit&nbsp;composite-mode&quot;,&nbsp;2048,2048,3,100,1);&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;Create&nbsp;Stack-&nbsp;Free&nbsp;memory:&quot;,IJ.freeMemory(),&nbsp;&quot;Currently&nbsp;in<br>
use:&quot;,IJ.currentMemory());<br>
&nbsp;&nbsp;&nbsp;&nbsp;xx=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;yy=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;strname=&quot;montage&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;grayopt=&quot;color_mode=Grayscale&nbsp;view=Hyperstack&nbsp;stack_order=XYCZT&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;for(i=0;i&lt;dirList.length;i++){<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(endsWith(dirList[i],&quot;.tif&quot;)||(endsWith(dirList[i],&quot;.tiff&quot;)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fList=Array.concat(fList,dirList[i]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(f=0;f&lt;fList.length;f++){<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fpath=dir+fList[f];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//showStatus(&quot;Opening&nbsp;stack&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run(&quot;Bio-Formats&nbsp;Windowless&nbsp;Importer&quot;,&nbsp;&quot;open=[fpath]&nbsp;[grayopt]&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rename(&quot;Source&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run(&quot;Insert...&quot;,&nbsp;&quot;source=Source&nbsp;destination=Hyperstack&nbsp;x=xx&nbsp;y=yy&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run(&quot;Close&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;Add&nbsp;Stack&nbsp;&quot;+f+&quot;:&quot;,IJ.freeMemory(),&nbsp;&quot;Currently&nbsp;in<br>
use:&quot;,IJ.currentMemory());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xx+=1024;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(xx==2048)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xx&nbsp;=&nbsp;0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yy&nbsp;+=&nbsp;1024;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;run(&quot;Close&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;//print(&quot;Free&nbsp;memory:&quot;,IJ.freeMemory(),&nbsp;&quot;Currently&nbsp;in<br>
use:&quot;,IJ.currentMemory());<br>
}<br>
<br>
<br>
<br>
regards<br>
<br>
Glen&nbsp;MacDonald<br>
&nbsp;&nbsp;&nbsp;&nbsp;Core&nbsp;for&nbsp;Communication&nbsp;Research<br>
Virginia&nbsp;Merrill&nbsp;Bloedel&nbsp;Hearing&nbsp;Research&nbsp;Center<br>
&nbsp;&nbsp;&nbsp;&nbsp;Cellular&nbsp;Morphology&nbsp;Core<br>
Center&nbsp;on&nbsp;Human&nbsp;Development&nbsp;and&nbsp;Disability<br>
Box&nbsp;357923<br>
University&nbsp;of&nbsp;Washington<br>
Seattle,&nbsp;WA&nbsp;98195-7923&nbsp;&nbsp;USA<br>
(206)&nbsp;616-4156<br>
&lt;a&nbsp;href=&quot;mailto:glenmac&#64;uw.edu&quot;&gt;glenmac&#64;uw.edu&lt;/a&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
On&nbsp;Jan&nbsp;21,&nbsp;2015,&nbsp;at&nbsp;6:54&nbsp;PM,&nbsp;&lt;a&nbsp;href=&quot;mailto:bugzilla&#64;fiji.sc&quot;&gt;bugzilla&#64;fiji.sc&lt;/a&gt;&nbsp;wrote:<br>
<br>
Wayne&nbsp;Rasband&nbsp;changed&nbsp;&lt;a&nbsp;class=&quot;bz_bug_link&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bz_status_NEW&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;title=&quot;NEW&nbsp;-&nbsp;Mac&nbsp;OS&nbsp;out&nbsp;of&nbsp;memory&quot;<br>
&nbsp;&nbsp;&nbsp;href=&quot;show_bug.cgi?id=990&quot;&gt;bug&nbsp;990&lt;/a&gt;&nbsp;<br>
What&nbsp;&nbsp;&nbsp;&nbsp;Removed&nbsp;&nbsp;&nbsp;&nbsp;Added<br>
CC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;mailto:wsr&#64;nih.gov&quot;&gt;wsr&#64;nih.gov&lt;/a&gt;<br>
<br>
&lt;a&nbsp;href=&quot;show_bug.cgi?id=990#c1&quot;&gt;Comment&nbsp;#&nbsp;1&lt;/a&gt;&nbsp;on&nbsp;&lt;a&nbsp;class=&quot;bz_bug_link&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bz_status_NEW&nbsp;&quot;<br>
&nbsp;&nbsp;&nbsp;title=&quot;NEW&nbsp;-&nbsp;Mac&nbsp;OS&nbsp;out&nbsp;of&nbsp;memory&quot;<br>
&nbsp;&nbsp;&nbsp;href=&quot;show_bug.cgi?id=990&quot;&gt;bug&nbsp;990&lt;/a&gt;&nbsp;from&nbsp;Wayne&nbsp;Rasband<br>
Could&nbsp;you&nbsp;provide&nbsp;a&nbsp;small&nbsp;test&nbsp;macro&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;to&nbsp;reproduce&nbsp;this&nbsp;problem?<br>
The&nbsp;following&nbsp;macro&nbsp;works&nbsp;as&nbsp;expected.&nbsp;The&nbsp;memory&nbsp;used&nbsp;by&nbsp;the&nbsp;four&nbsp;512x512x100<br>
temporary&nbsp;stacks&nbsp;it&nbsp;opens&nbsp;(25MB&nbsp;each)&nbsp;is&nbsp;reclaimed.<br>
<br>
&nbsp;newImage(&quot;Montage&quot;,&nbsp;&quot;8-bit&nbsp;ramp&quot;,&nbsp;1024,&nbsp;1024,&nbsp;100);<br>
&nbsp;x=0;&nbsp;y=0<br>
&nbsp;for&nbsp;(i=0;&nbsp;i&lt;4;&nbsp;i++)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;newImage(&quot;Stack&quot;,&nbsp;&quot;8-bit&nbsp;ramp&quot;,&nbsp;512,&nbsp;512,&nbsp;100);<br>
&nbsp;&nbsp;&nbsp;run(&quot;Insert...&quot;,&nbsp;&quot;source=Stack&nbsp;destination=Montage&nbsp;x=&amp;x&nbsp;y=&amp;y&quot;);<br>
&nbsp;&nbsp;&nbsp;close();<br>
&nbsp;&nbsp;&nbsp;x&nbsp;+=&nbsp;512;<br>
&nbsp;&nbsp;&nbsp;if&nbsp;(x==1024)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;+=&nbsp;512;<br>
&nbsp;&nbsp;&nbsp;}<br>
&nbsp;}<br>
&nbsp;setBatchMode(false);<br>
<br>
<br>
You&nbsp;are&nbsp;receiving&nbsp;this&nbsp;mail&nbsp;because:<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;You&nbsp;are&nbsp;on&nbsp;the&nbsp;CC&nbsp;list&nbsp;for&nbsp;the&nbsp;bug.<br>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;You&nbsp;reported&nbsp;the&nbsp;bug.&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;hr&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&gt;You&nbsp;are&nbsp;receiving&nbsp;this&nbsp;mail&nbsp;because:&lt;/span&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;You&nbsp;are&nbsp;the&nbsp;assignee&nbsp;for&nbsp;the&nbsp;bug.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
