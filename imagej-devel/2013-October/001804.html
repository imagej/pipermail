<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [ImageJ-devel] Avian VM and Bio-Formats
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:imagej-devel%40imagej.net?Subject=Re%3A%20%5BImageJ-devel%5D%20Avian%20VM%20and%20Bio-Formats&In-Reply-To=%3CCAHC%3DqdDhed-0ZhVBwZm5BXth9esZGDQrt9znrFzRFfrh6E9gRw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001797.html">
   <LINK REL="Next"  HREF="001785.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[ImageJ-devel] Avian VM and Bio-Formats</H1>
    <B>Yili Zhao</B> 
    <A HREF="mailto:imagej-devel%40imagej.net?Subject=Re%3A%20%5BImageJ-devel%5D%20Avian%20VM%20and%20Bio-Formats&In-Reply-To=%3CCAHC%3DqdDhed-0ZhVBwZm5BXth9esZGDQrt9znrFzRFfrh6E9gRw%40mail.gmail.com%3E"
       TITLE="[ImageJ-devel] Avian VM and Bio-Formats">panovr at gmail.com
       </A><BR>
    <I>Wed Oct 23 08:25:28 CDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="001797.html">[ImageJ-devel] Avian VM and Bio-Formats
</A></li>
        <LI>Next message: <A HREF="001785.html">[ImageJ-devel] [VIGRA] Avian VM and Bio-Formats
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1804">[ date ]</a>
              <a href="thread.html#1804">[ thread ]</a>
              <a href="subject.html#1804">[ subject ]</a>
              <a href="author.html#1804">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Stephan,
  thanks for the information!

  I should have read them in more detail :)

  And thanks for the ITK introduction. I used VTK a bit, and CMake
somtimes, and now I know they are trinity.


2013/10/19 Stephan Saalfeld &lt;<A HREF="http://imagej.net/mailman/listinfo/imagej-devel">saalfeld at mpi-cbg.de</A>&gt;

&gt;<i> Hi Yili,
</I>&gt;<i>
</I>&gt;<i> that is you didn't read beyond the first paragraph of the introduction:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://bioinformatics.oxfordjournals.org/content/28/22/3009.full">http://bioinformatics.oxfordjournals.org/content/28/22/3009.full</A>
</I>&gt;<i>
</I>&gt;<i> , or the first paragraph of the conclusion in the ImgLib1 workshop
</I>&gt;<i> paper:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://fly.mpi-cbg.de/~preibisch/pubs/imagejpaper2010.pdf">http://fly.mpi-cbg.de/~preibisch/pubs/imagejpaper2010.pdf</A>
</I>&gt;<i>
</I>&gt;<i> ?  Depressing for the authors ;).
</I>&gt;<i>
</I>&gt;<i> The other significant source of inspiration is ITK, if you don't know it
</I>&gt;<i> yet, check it out, also very cool stuff:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.itk.org/">http://www.itk.org/</A>
</I>&gt;<i>
</I>&gt;<i> Best,
</I>&gt;<i> Stephan
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sat, 2013-10-19 at 17:13 +0800, Yili Zhao wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;   &gt;&gt; Its design was the most important source of inspiration for ImgLib2.
</I>&gt;<i> &gt;   Thanks for this information.
</I>&gt;<i> &gt;   When I read ImgLib2, I have a impression that its design has some
</I>&gt;<i> similar
</I>&gt;<i> &gt; with other library.
</I>&gt;<i> &gt;   Now I know this library is VIGRA :)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   By the way, I can not access
</I>&gt;<i> &gt; <A HREF="http://hci.iwr.uni-heidelberg.de/vigra&lt;">http://hci.iwr.uni-heidelberg.de/vigra&lt;</A>
</I>&gt;<i> <A HREF="http://hci.iwr.uni-heidelberg.de/vigra/%E2%80%8E">http://hci.iwr.uni-heidelberg.de/vigra/%E2%80%8E</A>&gt;/
</I>&gt;<i> &gt; currently.
</I>&gt;<i> &gt; Do others have this problem?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2013/10/17 Johannes Schindelin &lt;<A HREF="http://imagej.net/mailman/listinfo/imagej-devel">Johannes.Schindelin at gmx.de</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Hi Ullrich,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; a little background information for everybody else: Ullrich is the
</I>&gt;<i> &gt; &gt; inventor and maintainer of VIGRA, an incredibly powerful C++ library to
</I>&gt;<i> &gt; &gt; process and analyze images. Its design was the most important source of
</I>&gt;<i> &gt; &gt; inspiration for ImgLib2. As a consequence, I was really delighted to
</I>&gt;<i> meet
</I>&gt;<i> &gt; &gt; Ullrich at the EuBIAS meeting in Barcelona last week. Among other
</I>&gt;<i> things,
</I>&gt;<i> &gt; &gt; we talked extensively about ways to interoperate between ImgLib2 and
</I>&gt;<i> &gt; &gt; VIGRA, and the lack of support in VIGRA to read file formats via the
</I>&gt;<i> &gt; &gt; Bio-Formats library.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Also at that meeting, I got into contact with the OpenMole project,
</I>&gt;<i> and in
</I>&gt;<i> &gt; &gt; particular with Mark Hammons who not only explained patiently the
</I>&gt;<i> benefits
</I>&gt;<i> &gt; &gt; of the Scala language to me, but also pointed out the existence of the
</I>&gt;<i> &gt; &gt; Avian VM, a small, embeddable, BSD-licensed Java Virtual Machine
</I>&gt;<i> written
</I>&gt;<i> &gt; &gt; in C++, with a tiny Just-In-Time compiler, just enough to make it a
</I>&gt;<i> &gt; &gt; practical choice for running limited Java inside a C++ program/library:
</I>&gt;<i> &gt; &gt; <A HREF="http://oss.readytalk.com/avian/">http://oss.readytalk.com/avian/</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It is actually very, very, *very* limited, as I found out when I tried
</I>&gt;<i> to
</I>&gt;<i> &gt; &gt; get it to run the bfconvert tool of Bio-Formats.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; But I did get it to run bfconvert. To be precise, in my hands, the 5MB
</I>&gt;<i> &gt; &gt; executable compiled from my fork of Avian was able to run my
</I>&gt;<i> &gt; &gt; (minimally-diverging) Bio-Formats v4.4.8 fork's
</I>&gt;<i> &gt; &gt; loci.formats.tools.ImageConverter class to convert Fiji's icon.png (my
</I>&gt;<i> &gt; &gt; standard example) to a .tiff file (although the colors are off, but
</I>&gt;<i> &gt; &gt; running the same example with plain Java results in a byte-identical
</I>&gt;<i> &gt; &gt; file).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Although it is too early for proper benchmarking, things seem to be
</I>&gt;<i> &gt; &gt; comparable between Java and Avian: while Java is slightly faster in
</I>&gt;<i> what
</I>&gt;<i> &gt; &gt; time(1) calls &quot;real&quot; time (~0.54s vs ~0.72s), in terms of &quot;user&quot; time
</I>&gt;<i> &gt; &gt; roles are reversed (~0.70s vs ~0.63s). Roughly the same holds true for
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; dynamic Avian executable (which is only 11K and links to Avian's
</I>&gt;<i> libjvm.so
</I>&gt;<i> &gt; &gt; weighing in with a whopping 1.2M). The major benefit will most likely
</I>&gt;<i> be
</I>&gt;<i> &gt; &gt; space: linking to libjvm.so should be enough, the standard Java classes
</I>&gt;<i> &gt; &gt; are included therein. So you can get Java support in VIGRA (or any
</I>&gt;<i> other
</I>&gt;<i> &gt; &gt; C++ project) by adding a library that is slightly larger than one
</I>&gt;<i> &gt; &gt; megabyte.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Now to some more detailed explanations about the challenges I faced,
</I>&gt;<i> for
</I>&gt;<i> &gt; &gt; the technically-inclined.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On the Bio-Formats side, there are two major and one minor (and one
</I>&gt;<i> micro)
</I>&gt;<i> &gt; &gt; issue:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - to enable logging, Bio-Formats uses a cute hack called
</I>&gt;<i> &gt; &gt;   ReflectedUniverse, which is basically a scripting language for Java
</I>&gt;<i> &gt; &gt;   itself. However, it uses regular expressions, something that Avian's
</I>&gt;<i> &gt; &gt;   class library does not yet support.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - Bio-Formats uses a concurrent hashmap in loci.common.Location.
</I>&gt;<i> &gt; &gt;   Concurrency (JSR-166) is not supported by Avian's class library yet.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - in loci.formats.gui.LegacyQTTools, the value of the java.library.path
</I>&gt;<i> &gt; &gt;   property is used without checking whether the property is null
</I>&gt;<i> (unset).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - some debug logging in Bio-Formats uses String.format() (not yet
</I>&gt;<i> &gt; &gt;   supported by Avian's class library).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; All of these issues could be worked around in the code calling
</I>&gt;<i> &gt; &gt; Bio-Formats: there is no need to use the ImageConverter class (which
</I>&gt;<i> &gt; &gt; enables the logging), the concurrent hashmap could be faked by
</I>&gt;<i> extending
</I>&gt;<i> &gt; &gt; the non-concurrent hashmap (and just not bothering with the concurrency
</I>&gt;<i> &gt; &gt; because we will most likely instantiate one VM per Bio-Formats call),
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; java.library.path property could be initialized to a dummy value and
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; logging could be switched off completely.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On the Avian side, I am happy to report that I only had to extend the
</I>&gt;<i> &gt; &gt; class library (apart from one bug fix that I will contribute upstream
</I>&gt;<i> &gt; &gt; later this week). In particular, I had to
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - make RandomAccessFile support writing
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - provide three dummy AWT classes because Bio-Formats actually links to
</I>&gt;<i> &gt; &gt;   them, but does not use them by default
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - provide a couple of interfaces and exceptions that were not yet
</I>&gt;<i> included
</I>&gt;<i> &gt; &gt;   in Avian
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - implement a minimal java.io.DataOutputStream
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - provide a FileChannel for RandomAccessFiles (i.e. implement
</I>&gt;<i> getChannel)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - implement java.lang.Boolean's parse(String) method
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - implement java.lang.Character's isISOControl(char) method
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - implement fake byte order methods for ByteBuffers (they are
</I>&gt;<i> hardcoded to
</I>&gt;<i> &gt; &gt;   big endian, but that is what Bio-Formats required in my test)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - provide a dummy SimpleDateFormat which actually does not work, but
</I>&gt;<i> does
</I>&gt;<i> &gt; &gt;   not need to
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - add toString(long[]) to java.util.Arrays
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; - teach Avian's pseudo regular expressions about &quot;\\&quot;, i.e. the
</I>&gt;<i> backslash
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; For the moment, all of these changes are contained in hodge podge
</I>&gt;<i> &gt; &gt; work-in-progress commits which I will clean up over the next few days.
</I>&gt;<i> You
</I>&gt;<i> &gt; &gt; can see them here (the linked pages will update whenever I get around
</I>&gt;<i> to
</I>&gt;<i> &gt; &gt; clean up the commits):
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; <A HREF="https://github.com/dscho/avian/compare/bio-formats">https://github.com/dscho/avian/compare/bio-formats</A>
</I>&gt;<i> &gt; &gt; <A HREF="https://github.com/dscho/bioformats/compare/v4.4.8...avian">https://github.com/dscho/bioformats/compare/v4.4.8...avian</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Since VIGRA and ImgLib2 share design concepts, and since SCIFIO
</I>&gt;<i> supports
</I>&gt;<i> &gt; &gt; ImgLib2 natively, I think that my plan to extend the test to SCIFIO
</I>&gt;<i> after
</I>&gt;<i> &gt; &gt; cleaning up my Avian fork is sound.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Once that is done, I will add unit tests that our trusty Jenkins will
</I>&gt;<i> run
</I>&gt;<i> &gt; &gt; whenever SCIFIO (or Avian) changes, to ensure that things continue to
</I>&gt;<i> &gt; &gt; work. These unit tests will be extended as needed, e.g. when someone
</I>&gt;<i> finds
</I>&gt;<i> &gt; &gt; out that an important use case requires more changes in Avian, still.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; This way to call Bio-Formats and SCIFIO could become the default C++
</I>&gt;<i> entry
</I>&gt;<i> &gt; &gt; point into those libraries.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Summary: I showed that Bio-Formats/SCIFIO support for VIGRA and other
</I>&gt;<i> C++
</I>&gt;<i> &gt; &gt; libraries is feasible through the BSD-licensed embeddable Java virtual
</I>&gt;<i> &gt; &gt; machine &quot;Avian&quot;. I am confident that I can clean up my patches this
</I>&gt;<i> week
</I>&gt;<i> &gt; &gt; still, to be contributed to the Avian project.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Ciao,
</I>&gt;<i> &gt; &gt; Johannes
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; ImageJ-devel mailing list
</I>&gt;<i> &gt; &gt; <A HREF="http://imagej.net/mailman/listinfo/imagej-devel">ImageJ-devel at imagej.net</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://imagej.net/mailman/listinfo/imagej-devel">http://imagej.net/mailman/listinfo/imagej-devel</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; ImageJ-devel mailing list
</I>&gt;<i> &gt; <A HREF="http://imagej.net/mailman/listinfo/imagej-devel">ImageJ-devel at imagej.net</A>
</I>&gt;<i> &gt; <A HREF="http://imagej.net/mailman/listinfo/imagej-devel">http://imagej.net/mailman/listinfo/imagej-devel</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Yili Zhao
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://imagej.net/pipermail/imagej-devel/attachments/20131023/98c1370a/attachment.html">http://imagej.net/pipermail/imagej-devel/attachments/20131023/98c1370a/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001797.html">[ImageJ-devel] Avian VM and Bio-Formats
</A></li>
	<LI>Next message: <A HREF="001785.html">[ImageJ-devel] [VIGRA] Avian VM and Bio-Formats
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1804">[ date ]</a>
              <a href="thread.html#1804">[ thread ]</a>
              <a href="subject.html#1804">[ subject ]</a>
              <a href="author.html#1804">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://imagej.net/mailman/listinfo/imagej-devel">More information about the ImageJ-devel
mailing list</a><br>
</body></html>
