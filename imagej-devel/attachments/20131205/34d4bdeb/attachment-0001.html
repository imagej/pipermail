<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=windows-1252&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;Hi&nbsp;guys,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;made&nbsp;a&nbsp;benchmark&nbsp;for&nbsp;ArrayImg&nbsp;backed&nbsp;by&lt;/div&gt;&lt;div&gt;-&nbsp;primitive&nbsp;arrays&lt;/div&gt;&lt;div&gt;-&nbsp;direct&nbsp;buffers&lt;/div&gt;&lt;div&gt;-&nbsp;sun.misc.Unsafe&nbsp;(off-heap&nbsp;memory)&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/imagej/imglib/blob/2e1929873e2f4bafcfe9d90ad616fedb8b7ed4f0/tests/src/test/java/net/imglib2/img/BufferAndUnsafeBenchmark.java&quot;&gt;https://github.com/imagej/imglib/blob/2e1929873e2f4bafcfe9d90ad616fedb8b7ed4f0/tests/src/test/java/net/imglib2/img/BufferAndUnsafeBenchmark.java&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;(in&nbsp;branch&nbsp;&quot;buffer-and-unsafe&quot;)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;my&nbsp;computer,&nbsp;the&nbsp;result&nbsp;is&nbsp;that&nbsp;Unsafe&nbsp;is&nbsp;the&nbsp;about&nbsp;the&nbsp;same&nbsp;speed&nbsp;as&nbsp;primitive&nbsp;arrays.&nbsp;Direct&nbsp;buffers&nbsp;are&nbsp;consistently&nbsp;slower:&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Monaco;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Monaco;&nbsp;&quot;&gt;copy&nbsp;image&nbsp;using&nbsp;class&nbsp;net.imglib2.img.array.ArrayImgFactory&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Monaco;&nbsp;&quot;&gt;median:&nbsp;52&nbsp;ms&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Monaco;&nbsp;min-height:&nbsp;15px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;copy&nbsp;image&nbsp;using&nbsp;class&nbsp;net.imglib2.img.array.ArrayImgUnsafeFactory&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;median:&nbsp;52&nbsp;ms&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;min-height:&nbsp;15px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;copy&nbsp;image&nbsp;using&nbsp;class&nbsp;net.imglib2.img.array.ArrayImgBufferFactory&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;median:&nbsp;59&nbsp;ms&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;min-height:&nbsp;15px;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;not-so-good&nbsp;news&nbsp;is&nbsp;that&nbsp;using&nbsp;the&nbsp;same&nbsp;type&nbsp;backed&nbsp;by&nbsp;different&nbsp;accesses&nbsp;will&nbsp;make&nbsp;the&nbsp;calls&nbsp;into&nbsp;the&nbsp;ByteAccess&nbsp;(or&nbsp;whatever&nbsp;the&nbsp;type&nbsp;is)&nbsp;polymorphic,&nbsp;spoiling&nbsp;it&nbsp;for&nbsp;the&nbsp;JIT&nbsp;(at&nbsp;least&nbsp;if&nbsp;both&nbsp;are&nbsp;used&nbsp;from&nbsp;the&nbsp;same&nbsp;call-site).&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;visible&nbsp;in&nbsp;the&nbsp;second&nbsp;part&nbsp;of&nbsp;the&nbsp;benchmark.&nbsp;Here,&nbsp;a&nbsp;constant&nbsp;UnsignedByteType&nbsp;is&nbsp;added&nbsp;to&nbsp;every&nbsp;pixel&nbsp;of&nbsp;the&nbsp;image.&nbsp;Because&nbsp;the&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;color:&nbsp;rgb(147,&nbsp;26,&nbsp;104);&nbsp;&quot;&gt;new&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;&nbsp;UnsignedByteType(1)&lt;/span&gt;&nbsp;is&nbsp;always&nbsp;backed&nbsp;by&nbsp;a&nbsp;primitive&nbsp;array,&nbsp;we&nbsp;hit&nbsp;the&nbsp;bimorphic&nbsp;case&nbsp;for&nbsp;Unsafe&nbsp;and&nbsp;direct&nbsp;buffer,&nbsp;and&nbsp;this&nbsp;results&nbsp;in&nbsp;a&nbsp;big&nbsp;slowdown:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Monaco;&nbsp;&quot;&gt;add&nbsp;constant&nbsp;to&nbsp;image&nbsp;using&nbsp;class&nbsp;net.imglib2.img.array.ArrayImgFactory&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Monaco;&nbsp;&quot;&gt;median:&nbsp;22&nbsp;ms&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;margin:&nbsp;0px;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;margin:&nbsp;0px;&nbsp;&quot;&gt;add&nbsp;constant&nbsp;to&nbsp;image&nbsp;using&nbsp;class&nbsp;net.imglib2.img.array.ArrayImgUnsafeFactory&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;margin:&nbsp;0px;&nbsp;&quot;&gt;median:&nbsp;122&nbsp;ms&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;margin:&nbsp;0px;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;margin:&nbsp;0px;&nbsp;&quot;&gt;add&nbsp;constant&nbsp;to&nbsp;image&nbsp;using&nbsp;class&nbsp;net.imglib2.img.array.ArrayImgBufferFactory&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;margin:&nbsp;0px;&nbsp;&quot;&gt;median:&nbsp;186&nbsp;ms&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;We&nbsp;can&nbsp;try&nbsp;some&nbsp;tricks&nbsp;to&nbsp;make&nbsp;UnsignedByteType&nbsp;constants&nbsp;backed&nbsp;by&nbsp;the&nbsp;other&nbsp;ByteAccess&nbsp;types,&nbsp;but&nbsp;in&nbsp;general&nbsp;I&nbsp;see&nbsp;no&nbsp;easy&nbsp;way&nbsp;around&nbsp;this.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Maybe&nbsp;someone&nbsp;has&nbsp;a&nbsp;few&nbsp;months&nbsp;to&nbsp;spare&nbsp;to&nbsp;make&nbsp;imglib3&nbsp;using&nbsp;ASM&nbsp;or&nbsp;Javassist&nbsp;to&nbsp;manually&nbsp;inline&nbsp;this&nbsp;stuff&nbsp;(that&nbsp;would&nbsp;solve&nbsp;the&nbsp;bottleneck&nbsp;in&nbsp;making&nbsp;a&nbsp;proper&nbsp;bidirectional&nbsp;read/write&nbsp;type&nbsp;hierarchy…)&nbsp;Of&nbsp;course,&nbsp;we&nbsp;can&nbsp;always&nbsp;hope&nbsp;that&nbsp;the&nbsp;JIT&nbsp;will&nbsp;&quot;get&nbsp;it&quot;&nbsp;at&nbsp;some&nbsp;point&nbsp;in&nbsp;the&nbsp;future,&nbsp;but&nbsp;I&nbsp;think&nbsp;this&nbsp;is&nbsp;quite&nbsp;a&nbsp;pathological&nbsp;case.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think,&nbsp;we&nbsp;should&nbsp;go&nbsp;for&nbsp;the&nbsp;sun.misc.Unsafe&nbsp;for&nbsp;now.&lt;/div&gt;&lt;div&gt;If&nbsp;it&nbsp;really&nbsp;turns&nbsp;out&nbsp;to&nbsp;be&nbsp;a&nbsp;show-stopper,&nbsp;we&nbsp;will&nbsp;have&nbsp;to&nbsp;look&nbsp;into&nbsp;using&nbsp;primitive&nbsp;arrays&nbsp;and&nbsp;pinning.&nbsp;One&nbsp;downside&nbsp;of&nbsp;that&nbsp;would&nbsp;be&nbsp;that&nbsp;then&nbsp;the&nbsp;memory&nbsp;must&nbsp;be&nbsp;owned&nbsp;by&nbsp;Java,&nbsp;so&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;for&nbsp;the&nbsp;Avian&nbsp;integration.&nbsp;Another&nbsp;downside&nbsp;is&nbsp;that&nbsp;JNI&nbsp;implementations&nbsp;are&nbsp;not&nbsp;forced&nbsp;to&nbsp;pin&nbsp;the&nbsp;array,&nbsp;they&nbsp;may&nbsp;just&nbsp;decide&nbsp;to&nbsp;copy&nbsp;the&nbsp;data.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;also&nbsp;made&nbsp;a&nbsp;imglib2-vigra&nbsp;branch&nbsp;that&nbsp;uses&nbsp;Unsafe&nbsp;&lt;a&nbsp;href=&quot;https://github.com/tpietzsch/vigra-imglib2/commits/unsafe&quot;&gt;https://github.com/tpietzsch/vigra-imglib2/commits/unsafe&lt;/a&gt;&nbsp;(requires&nbsp;the&nbsp;buffer-and-unsafe&nbsp;branch&nbsp;of&nbsp;imglib2).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;best&nbsp;regards,&lt;/div&gt;&lt;div&gt;Tobias&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Nov&nbsp;30,&nbsp;2013,&nbsp;at&nbsp;12:36&nbsp;AM,&nbsp;Tobias&nbsp;Pietzsch&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:pietzsch@mpi-cbg.de&quot;&gt;pietzsch@mpi-cbg.de&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=iso-8859-1&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;Hi&nbsp;Johannes&nbsp;and&nbsp;Ulli,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;with&nbsp;respect&nbsp;to&nbsp;the&nbsp;need&nbsp;to&nbsp;set&nbsp;up&nbsp;the&nbsp;paths&nbsp;in&nbsp;the&nbsp;pom.xml:&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;an&nbsp;issue&nbsp;with&nbsp;the&nbsp;nar-maven-plugin,&nbsp;which&nbsp;compiles&nbsp;and&nbsp;packages&nbsp;the&nbsp;native&nbsp;code.&lt;/div&gt;&lt;div&gt;With&nbsp;Johannes'&nbsp;help,&nbsp;I&nbsp;submitted&nbsp;an&nbsp;integration&nbsp;test&nbsp;to&nbsp;the&nbsp;nar-maven-plugin&nbsp;project,&nbsp;that&nbsp;illustrates&nbsp;this&nbsp;problem.&nbsp;So&nbsp;hopefully&nbsp;it&nbsp;will&nbsp;be&nbsp;fixed&nbsp;at&nbsp;some&nbsp;point&nbsp;in&nbsp;the&nbsp;future.&lt;/div&gt;&lt;div&gt;Ulli,&nbsp;I&nbsp;remember&nbsp;that&nbsp;there&nbsp;was&nbsp;another&nbsp;issue&nbsp;on&nbsp;Windows:&nbsp;The&nbsp;dll&nbsp;was&nbsp;named&nbsp;differently&nbsp;to&nbsp;what&nbsp;the&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;NarHelper&lt;/span&gt;&nbsp;class&nbsp;expects.&nbsp;Could&nbsp;you&nbsp;elaborate&nbsp;on&nbsp;that?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;With&nbsp;respect&nbsp;to&nbsp;what&nbsp;we&nbsp;did&nbsp;on&nbsp;the&nbsp;vigra-imglib2&nbsp;project.&nbsp;I&nbsp;forked&nbsp;your&nbsp;project,&nbsp;Johannes,&nbsp;&lt;a&nbsp;href=&quot;https://github.com/tpietzsch/vigra-imglib2&quot;&gt;https://github.com/tpietzsch/vigra-imglib2&lt;/a&gt;.&lt;/div&gt;&lt;div&gt;We&nbsp;worked&nbsp;on&nbsp;the&nbsp;&quot;buffer&quot;&nbsp;branch.&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;using&nbsp;direct&nbsp;buffers&nbsp;as&nbsp;the&nbsp;underlying&nbsp;data&nbsp;structure&nbsp;for&nbsp;both&nbsp;ImgLib2's&nbsp;ArrayImg&nbsp;and&nbsp;VIGRA's&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;MultiArrayView&lt;/span&gt;.&nbsp;At&nbsp;the&nbsp;moment,&nbsp;the&nbsp;direct&nbsp;buffer&nbsp;is&nbsp;allocated&nbsp;on&nbsp;the&nbsp;Java&nbsp;side,&nbsp;but&nbsp;as&nbsp;you&nbsp;pointed&nbsp;out,&nbsp;one&nbsp;can&nbsp;use&nbsp;JNI's&nbsp;NewDirectByteBuffer()&nbsp;from&nbsp;the&nbsp;C++&nbsp;side.&nbsp;I&nbsp;think&nbsp;this&nbsp;is&nbsp;a&nbsp;good&nbsp;solution,&nbsp;because&nbsp;it&nbsp;leaves&nbsp;the&nbsp;option&nbsp;for&nbsp;both&nbsp;scenarios,&nbsp;Java&nbsp;embedded&nbsp;in&nbsp;C++&nbsp;and&nbsp;C++&nbsp;embedded&nbsp;in&nbsp;Java.&nbsp;The&nbsp;ByteBuffer&nbsp;is&nbsp;wrapped&nbsp;in&nbsp;a&nbsp;ImgLib2&nbsp;Access&nbsp;(e.g.&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;IntAccess&lt;/span&gt;&nbsp;for&nbsp;Imgs&nbsp;of&nbsp;IntType.&nbsp;It&nbsp;is&nbsp;easy&nbsp;to&nbsp;provide&nbsp;two&nbsp;constructors&nbsp;there,&nbsp;one&nbsp;which&nbsp;allocates&nbsp;the&nbsp;buffer&nbsp;and&nbsp;one&nbsp;which&nbsp;takes&nbsp;an&nbsp;existing&nbsp;buffer.&nbsp;Responsibility&nbsp;for&nbsp;freeing&nbsp;the&nbsp;memory&nbsp;is&nbsp;not&nbsp;a&nbsp;problem.&nbsp;Note&nbsp;that&nbsp;JNI&nbsp;NewDirectByteBuffer&nbsp;is&nbsp;constructed&nbsp;with&nbsp;already&nbsp;allocated&nbsp;memory.&nbsp;So,&nbsp;if&nbsp;C++&nbsp;allocated&nbsp;the&nbsp;memory,&nbsp;Java&nbsp;may&nbsp;garbage-collect&nbsp;the&nbsp;ByteBuffer,&nbsp;but&nbsp;will&nbsp;not&nbsp;free&nbsp;the&nbsp;memory&nbsp;block.&nbsp;If&nbsp;creating&nbsp;the&nbsp;ByteBuffer&nbsp;form&nbsp;Java,&nbsp;Java&nbsp;will&nbsp;also&nbsp;free&nbsp;the&nbsp;memory.&lt;/div&gt;&lt;div&gt;The&nbsp;good&nbsp;thing&nbsp;is&nbsp;that&nbsp;both&nbsp;ImgLib&nbsp;ArrayImgs&nbsp;and&nbsp;VIGRA&nbsp;MultiArrayViews&nbsp;were&nbsp;designed&nbsp;to&nbsp;wrap&nbsp;flat&nbsp;arrays,&nbsp;which&nbsp;is&nbsp;what&nbsp;is&nbsp;happening&nbsp;here.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;ByteBuffer&nbsp;code&nbsp;came&nbsp;from&nbsp;the&nbsp;ImgLib2&nbsp;branch&nbsp;&quot;buffer-and-unsafe&quot;,&nbsp;where&nbsp;I&nbsp;played&nbsp;with&nbsp;using&nbsp;direct&nbsp;buffers&nbsp;and&nbsp;sun.misc.Unsafe&nbsp;to&nbsp;back&nbsp;ArrayImgs&nbsp;instead&nbsp;of&nbsp;Java&nbsp;primitive&nbsp;arrays.&lt;/div&gt;&lt;div&gt;sun.misc.Unsafe&nbsp;is&nbsp;the&nbsp;other&nbsp;viable&nbsp;option.&nbsp;In&nbsp;contrast&nbsp;to&nbsp;primitive&nbsp;arrays&nbsp;and&nbsp;direct&nbsp;buffers&nbsp;it&nbsp;does&nbsp;not&nbsp;suffer&nbsp;from&nbsp;the&nbsp;2G&nbsp;size&nbsp;limit&nbsp;of&nbsp;Java&nbsp;arrays.&nbsp;Of&nbsp;course,&nbsp;if&nbsp;we&nbsp;put&nbsp;it&nbsp;behind&nbsp;an&nbsp;ArrayImg,&nbsp;we&nbsp;cannot&nbsp;make&nbsp;use&nbsp;of&nbsp;that&nbsp;fact&nbsp;yet.&nbsp;So&nbsp;we&nbsp;could&nbsp;have&nbsp;a&nbsp;BigArrayImg&nbsp;at&nbsp;some&nbsp;point&nbsp;in&nbsp;the&nbsp;future&nbsp;(which&nbsp;would&nbsp;be&nbsp;useful&nbsp;in&nbsp;its&nbsp;own&nbsp;right).&nbsp;Otherwise,&nbsp;same&nbsp;advantages&nbsp;as&nbsp;explained&nbsp;above.&lt;/div&gt;&lt;div&gt;The&nbsp;benchmark&nbsp;that&nbsp;Johannes&nbsp;mentioned&nbsp;was&nbsp;comparing&nbsp;the&nbsp;speed&nbsp;of&nbsp;ArrayImgs&nbsp;backed&nbsp;by&nbsp;primitive&nbsp;arrays,&nbsp;direct&nbsp;buffers,&nbsp;and&nbsp;sun.misc.Unsafe,&nbsp;respectively.&nbsp;I&nbsp;just&nbsp;had&nbsp;a&nbsp;look&nbsp;and&nbsp;I&nbsp;couldn't&nbsp;find&nbsp;it.&nbsp;I'll&nbsp;recreate&nbsp;it&nbsp;next&nbsp;week.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Note,&nbsp;that&nbsp;I&nbsp;copied&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;stuff&nbsp;from&nbsp;the&nbsp;ImgLib2&nbsp;branch&nbsp;&quot;buffer-and-unsafe&quot;,&nbsp;so&nbsp;that&nbsp;vigra-imglib2&nbsp;works&nbsp;with&nbsp;the&nbsp;current&nbsp;ImgLib2&nbsp;beta.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;wrapping&nbsp;the&nbsp;images&nbsp;back&nbsp;and&nbsp;forth&nbsp;was&nbsp;only&nbsp;part&nbsp;of&nbsp;what&nbsp;we&nbsp;did.&nbsp;An&nbsp;important&nbsp;point&nbsp;is&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to&nbsp;make&nbsp;bindings&nbsp;to&nbsp;VIGRA&nbsp;functions&nbsp;withou&nbsp;writing&nbsp;lots&nbsp;of&nbsp;boilderplate&nbsp;code&nbsp;on&nbsp;either&nbsp;side&nbsp;of&nbsp;JNI.&nbsp;Based&nbsp;on&nbsp;earlier&nbsp;VIGRA-Matlab&nbsp;wrapper&nbsp;we&nbsp;made&nbsp;some&nbsp;macros&nbsp;that&nbsp;allow&nbsp;to&nbsp;write&nbsp;on&nbsp;the&nbsp;C++&nbsp;side&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Monaco;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;JNIEXPORT&nbsp;void&nbsp;JNICALL&nbsp;Java_net_imglib2_vigra_VigraWrapper_gaussianSmoothMultiArray&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&nbsp;&nbsp;(JNIEnv&nbsp;*&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;env&lt;/span&gt;,&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;jclass&lt;/span&gt;,&nbsp;jlongArray&nbsp;shape,&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;jint&lt;/span&gt;&nbsp;typeId,&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;jobject&lt;/span&gt;&nbsp;sourceData,&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;jobject&lt;/span&gt;&nbsp;destData,&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;jdouble&lt;/span&gt;&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;sigma&lt;/span&gt;)&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;{&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;using&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;namespace&lt;/span&gt;&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;vigra&lt;/span&gt;;&nbsp;//&nbsp;to&nbsp;get&nbsp;UInt8&nbsp;and&nbsp;Int32&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;#define&nbsp;F(T)&nbsp;gaussianSmoothMultiArray&lt;T&gt;(&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;env&lt;/span&gt;,&nbsp;shape,&nbsp;typeId,&nbsp;sourceData,&nbsp;destData,&nbsp;&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;sigma&lt;/span&gt;)&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;ALLOW_TYPES(typeId,&nbsp;UInt8,&nbsp;Int32,&nbsp;float)&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;#&lt;span&nbsp;style=&quot;text-decoration:&nbsp;underline&quot;&gt;undef&lt;/span&gt;&nbsp;F&lt;/div&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;&quot;&gt;}&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;This&nbsp;creates&nbsp;a&nbsp;switch&nbsp;statement&nbsp;that&nbsp;instantiates&nbsp;the&nbsp;VIGRA&nbsp;template&nbsp;function&nbsp;for&nbsp;the&nbsp;specified&nbsp;C++&nbsp;types&nbsp;and&nbsp;dispatches&nbsp;to&nbsp;these&nbsp;according&nbsp;to&nbsp;the&nbsp;corresponding&nbsp;ImgLib&nbsp;type.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;The&nbsp;same&nbsp;is&nbsp;done&nbsp;for&nbsp;supported&nbsp;dimensionalities&nbsp;(because&nbsp;with&nbsp;templates&nbsp;we&nbsp;have&nbsp;to&nbsp;specify&nbsp;that&nbsp;at&nbsp;compile&nbsp;time).&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;The&nbsp;plan&nbsp;is&nbsp;to&nbsp;directly&nbsp;pass&nbsp;in&nbsp;the&nbsp;ArrayImg&nbsp;jobject&nbsp;(and&nbsp;maybe&nbsp;even&nbsp;views&nbsp;later)&nbsp;and&nbsp;extract&nbsp;the&nbsp;type&nbsp;and&nbsp;dimension&nbsp;etc&nbsp;directly&nbsp;from&nbsp;that.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;This&nbsp;would&nbsp;mean,&nbsp;that&nbsp;on&nbsp;the&nbsp;Java&nbsp;side,&nbsp;we&nbsp;only&nbsp;have&nbsp;one&nbsp;native&nbsp;method&nbsp;for&nbsp;each&nbsp;exported&nbsp;VIGRA&nbsp;function,&nbsp;basically&nbsp;with&nbsp;the&nbsp;same&nbsp;signature&nbsp;and&nbsp;just&nbsp;replacing&nbsp;MultiArrayView&nbsp;with&nbsp;Img.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;best&nbsp;regards,&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;Tobias&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;_______________________________________________&lt;br&gt;ImageJ-devel&nbsp;mailing&nbsp;list&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:ImageJ-devel@imagej.net&quot;&gt;ImageJ-devel@imagej.net&lt;/a&gt;&lt;br&gt;http://imagej.net/mailman/listinfo/imagej-devel&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
