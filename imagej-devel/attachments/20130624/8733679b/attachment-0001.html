<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=windows-1252&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ok,&nbsp;sorry&nbsp;for&nbsp;the&nbsp;lurid&nbsp;subject&nbsp;line&nbsp;-&nbsp;it's&nbsp;not&nbsp;that&nbsp;bad,&nbsp;but&nbsp;I&nbsp;think&nbsp;the&nbsp;&quot;incorrect&quot;&nbsp;part&nbsp;is&nbsp;kind&nbsp;of&nbsp;important.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;First&nbsp;regarding&nbsp;the&nbsp;slow&nbsp;(feel&nbsp;free&nbsp;to&nbsp;skip&nbsp;to&nbsp;this&nbsp;paragraph...).&nbsp;I&nbsp;played&nbsp;with&nbsp;unsigned&nbsp;short&nbsp;to&nbsp;ARGB&nbsp;conversion&nbsp;and&nbsp;noticed&nbsp;that&nbsp;it&nbsp;divides&nbsp;by&nbsp;scale&nbsp;factor&nbsp;for&nbsp;every&nbsp;pixel.&lt;/div&gt;&lt;div&gt;I&nbsp;thought&nbsp;that&nbsp;maybe&nbsp;we&nbsp;could&nbsp;speed&nbsp;it&nbsp;up&nbsp;a&nbsp;little&nbsp;by&nbsp;replacing&nbsp;that&nbsp;with&nbsp;a&nbsp;multiplication.&nbsp;Amazingly&nbsp;even&nbsp;in&nbsp;a&nbsp;language&nbsp;as&nbsp;Java&nbsp;that&nbsp;is&nbsp;seemingly&nbsp;far&nbsp;removed&nbsp;from&nbsp;the&nbsp;CPU&nbsp;this&nbsp;actually&nbsp;matters.&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;pushed&nbsp;a&nbsp;RealARGBConverterBenchmark&nbsp;which&nbsp;uses&nbsp;cursors&nbsp;and&nbsp;a&nbsp;converter&nbsp;to&nbsp;convert&nbsp;a&nbsp;UnsignedByteType&nbsp;image&nbsp;to&nbsp;ARGBType,&nbsp;&lt;a&nbsp;href=&quot;https://github.com/imagej/imglib/commit/fbdf633a8b6d1c2894f9ef08eb3a642c010ca44e&quot;&gt;https://github.com/imagej/imglib/commit/fbdf633a8b6d1c2894f9ef08eb3a642c010ca44e&lt;/a&gt;&lt;/div&gt;&lt;div&gt;Replacing&nbsp;the&nbsp;division&nbsp;to&nbsp;multiplication&nbsp;(and&nbsp;some&nbsp;minor&nbsp;tweaks)&nbsp;made&nbsp;the&nbsp;benchmark&nbsp;go&nbsp;from&nbsp;28ms&nbsp;to&nbsp;12ms,&nbsp;&lt;a&nbsp;href=&quot;https://github.com/imagej/imglib/commit/5c6f40f0492bee2159eebe1ffb1e5b5f1bcc6a8d&quot;&gt;https://github.com/imagej/imglib/commit/5c6f40f0492bee2159eebe1ffb1e5b5f1bcc6a8d&lt;/a&gt;.&nbsp;Amazing.&lt;/div&gt;&lt;div&gt;Then&nbsp;I&nbsp;wanted&nbsp;to&nbsp;do&nbsp;that&nbsp;for&nbsp;all&nbsp;of&nbsp;the&nbsp;converters,&nbsp;got&nbsp;side-tracked,&nbsp;and&nbsp;as&nbsp;usual&nbsp;the&nbsp;10-minute&nbsp;thing&nbsp;turned&nbsp;into&nbsp;2&nbsp;hours&nbsp;obsessing&nbsp;with&nbsp;details:&nbsp;is&nbsp;the&nbsp;converter&nbsp;math&nbsp;actually&nbsp;correct?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;the&nbsp;linear&nbsp;range&nbsp;conversion&nbsp;in&nbsp;the&nbsp;Real*Converters&nbsp;is&nbsp;wrong.&lt;/div&gt;&lt;div&gt;Mathematically,&nbsp;it&nbsp;is&nbsp;obviously&nbsp;simple.&nbsp;We&nbsp;have&nbsp;to&nbsp;intervals&nbsp;[minA,&nbsp;maxA]&nbsp;and&nbsp;[minB,&nbsp;maxB]&nbsp;and&nbsp;want&nbsp;to&nbsp;convert&nbsp;(linearly)&nbsp;xA&nbsp;to&nbsp;xB:&lt;/div&gt;&lt;div&gt;xB&nbsp;=&nbsp;minA&nbsp;+&nbsp;(xA&nbsp;-&nbsp;minA)&nbsp;/&nbsp;(maxA-minA)&nbsp;*&nbsp;(maxB-minB)&lt;/div&gt;&lt;div&gt;Thats&nbsp;exactly&nbsp;whats&nbsp;implemented&nbsp;in,&nbsp;for&nbsp;example,&nbsp;RealUnsignedByteConverter.&lt;/div&gt;&lt;div&gt;Where&nbsp;it&nbsp;gets&nbsp;tricky&nbsp;is&nbsp;quantisation.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;In&nbsp;RealUnsignedByteConverter:&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;output.set(&nbsp;Math.min(&nbsp;255,&nbsp;roundPositive(&nbsp;Math.max(&nbsp;0,&nbsp;(&nbsp;(&nbsp;a&nbsp;-&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;color:&nbsp;rgb(3,&nbsp;38,&nbsp;204);&nbsp;&quot;&gt;min&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;&nbsp;)&nbsp;/&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;color:&nbsp;rgb(3,&nbsp;38,&nbsp;204);&nbsp;&quot;&gt;scale&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;&nbsp;*&nbsp;255.0&nbsp;)&nbsp;)&nbsp;)&nbsp;)&nbsp;);&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Stripping&nbsp;the&nbsp;bounds&nbsp;check:&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;output.set(&nbsp;roundPositive(&nbsp;(&nbsp;a&nbsp;-&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;color:&nbsp;rgb(3,&nbsp;38,&nbsp;204);&nbsp;&quot;&gt;min&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;&nbsp;)&nbsp;/&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;color:&nbsp;rgb(3,&nbsp;38,&nbsp;204);&nbsp;&quot;&gt;scale&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;&nbsp;*&nbsp;255.0&nbsp;)&nbsp;);&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;where&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;roundPositive&lt;/span&gt;&nbsp;is&nbsp;just&nbsp;normal&nbsp;rounding,&nbsp;and&nbsp;&lt;span&nbsp;style=&quot;color:&nbsp;rgb(3,&nbsp;38,&nbsp;204);&nbsp;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;scale&lt;/span&gt;&nbsp;=&nbsp;(maxA-minA)&nbsp;as&nbsp;above&nbsp;and&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;255.0&nbsp;=&nbsp;(maxB-minB).&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;I&nbsp;think,&nbsp;the&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&nbsp;font-size:&nbsp;11px;&nbsp;&quot;&gt;roundPositive&lt;/span&gt;&nbsp;is&nbsp;supposed&nbsp;to&nbsp;take&nbsp;care&nbsp;of&nbsp;quantisation.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now&nbsp;let's&nbsp;look&nbsp;a&nbsp;simplified&nbsp;example&nbsp;where&nbsp;we&nbsp;want&nbsp;to&nbsp;convert&nbsp;a&nbsp;4-bit&nbsp;value&nbsp;into&nbsp;a&nbsp;2-bit&nbsp;value.&lt;/div&gt;&lt;div&gt;Intuitively&nbsp;I&nbsp;would&nbsp;expect&nbsp;the&nbsp;converter&nbsp;to&nbsp;perform&nbsp;a&nbsp;uniform&nbsp;re-binning.&nbsp;There&nbsp;are&nbsp;16&nbsp;4-bit&nbsp;values&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;distributed&nbsp;into&nbsp;4&nbsp;2-bit&nbsp;bins.&lt;/div&gt;&lt;div&gt;What&nbsp;should&nbsp;happen&nbsp;is&nbsp;that&nbsp;we&nbsp;keep&nbsp;the&nbsp;upper&nbsp;2&nbsp;bits&nbsp;of&nbsp;the&nbsp;4-bit&nbsp;value,&nbsp;that&nbsp;is:&lt;/div&gt;&lt;div&gt;0000-0011&nbsp;map&nbsp;to&nbsp;00&lt;/div&gt;&lt;div&gt;…&lt;/div&gt;&lt;div&gt;1100-1111&nbsp;map&nbsp;to&nbsp;11&lt;/div&gt;&lt;div&gt;At&nbsp;least&nbsp;that&nbsp;is&nbsp;what&nbsp;my&nbsp;intuition&nbsp;tells&nbsp;me.&lt;/div&gt;&lt;div&gt;Now&nbsp;if&nbsp;you&nbsp;go&nbsp;through&nbsp;the&nbsp;motions&nbsp;with&nbsp;the&nbsp;current&nbsp;converter&nbsp;logic&nbsp;you'll&nbsp;find&nbsp;that&nbsp;1100&nbsp;actually&nbsp;is&nbsp;mapped&nbsp;to&nbsp;10.&nbsp;Likewise,&nbsp;0011&nbsp;is&nbsp;mapped&nbsp;to&nbsp;01.&nbsp;There&nbsp;are&nbsp;2&nbsp;bins&nbsp;with&nbsp;3&nbsp;values&nbsp;each&nbsp;and&nbsp;2&nbsp;bins&nbsp;with&nbsp;5.&nbsp;Not&nbsp;uniform.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;this&nbsp;is&nbsp;wrong&nbsp;and&nbsp;I&nbsp;would&nbsp;fix&nbsp;it,&nbsp;but&nbsp;first&nbsp;I&nbsp;wanted&nbsp;to&nbsp;ask&nbsp;whether&nbsp;I'm&nbsp;missing&nbsp;something&nbsp;here?&lt;/div&gt;&lt;div&gt;Especially,&nbsp;Stephan,&nbsp;maybe&nbsp;you&nbsp;can&nbsp;comment&nbsp;because&nbsp;you&nbsp;implemented&nbsp;current&nbsp;logic.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;best&nbsp;regards,&lt;/div&gt;&lt;div&gt;Tobias&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
